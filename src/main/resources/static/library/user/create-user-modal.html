<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Добавление нового пользователя</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="login" class="form-label">Логин</label>
                        <input type="text" class="form-control" id="login" required 
                            pattern="[a-zA-Z0-9]{3,20}" 
                            title="Логин должен содержать 3-20 символов (латинские буквы и цифры)">
                    </div>
                    <div class="col-md-6">
                        <label for="password" class="form-label">Пароль</label>
                        <div class="input-group">
                        <input type="password" class="form-control" id="password" required
                                pattern=".{6,}" 
                                title="Минимум 6 символов">
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                            <i class="fas fa-eye"></i>
                        </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label for="lastName" class="form-label">Фамилия</label>
                        <input type="text" class="form-control" id="lastName" required
                            pattern="[А-Яа-яЁё\s-]{2,50}" 
                            title="Только кириллические буквы, дефисы и пробелы">
                    </div>
                    <div class="col-md-4">
                        <label for="firstName" class="form-label">Имя</label>
                        <input type="text" class="form-control" id="firstName" required
                            pattern="[А-Яа-яЁё\s-]{2,50}">
                    </div>
                    <div class="col-md-4">
                        <label for="middleName" class="form-label">Отчество</label>
                        <input type="text" class="form-control" id="middleName"
                            pattern="[А-Яа-яЁё\s-]{0,50}">
                    </div>
                    <div class="col-md-6">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required
                            placeholder="example@domain.com">
                    </div>
                    <div class="col-md-6">
                        <label for="phone" class="form-label">Телефон</label>
                        <input type="tel" class="form-control" id="phone"
                            placeholder="+379 (__) ___-__-__">
                    </div>
                    <div class="col-md-12">
                    <label for="roles" class="form-label">Роли</label>
                    <select class="form-control select2-multiple" id="roles" multiple="multiple" required
                            style="width: 100%;">
                        <option value="ROLE_ADMIN">Администратор</option>
                        <option value="ROLE_USER" selected>Пользователь</option>
                    </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveUserBtn">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<script>
    $(document).ready(function() {
        $('#roles').one('click', function() {
            $(this).select2({
            width: '100%',
            placeholder: $(this).data('placeholder'),
            closeOnSelect: false,
            allowClear: true,
            dropdownParent: $('#addUserModal')
            });
        });

        $('#phone').mask('+375 (29) 000-00-00', {placeholder: "+375 (__) ___-__-__"});

        $('#togglePassword').click(function() {
            const passwordField = $('#password');
            const type = passwordField.attr('type') === 'password' ? 'text' : 'password';
            passwordField.attr('type', type);
            $(this).find('i').toggleClass('fa-eye fa-eye-slash');
        });

        $('#saveUserBtn').click(function() {
            const form = $('#addUserForm')[0];
            if (!form.checkValidity()) {
            form.reportValidity();
            return;
            }
            
            const userData = {
            login: $('#login').val(),
            password: $('#password').val(),
            lastName: $('#lastName').val(),
            firstName: $('#firstName').val(),
            middleName: $('#middleName').val(),
            email: $('#email').val(),
            phone: $('#phone').cleanVal(), 
            roles: $('#roles').val()
            };
            
            $.ajax({
            url: '/api/users',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(userData),
            success: function(response) {
                $('#addUserModal').modal('hide');
                if (window.refreshUsersTable) {
                refreshUsersTable();
                }
            },
            error: function(xhr) {
                console.error('Ошибка:', xhr.responseText);
            }
            });
        });
    });
</script>